# Modbus 单次交易时延与抖动统计指南（含 P50/P95/P99）

本指南解释“单次交易时延”“抖动”的含义，给出 P50/P95/P99 分位数的定义与计算方法，并结合 STM32/FreeRTOS 场景给出实践建议与验收判据。

## 1. 概念与定义

- 单次交易时延（latency）：一次完整交易从发起到拿到结果的用时。
  - 典型测法：调用同步读写 API 前读取时间 t0，返回后读取 t1，样本 \(x = t1 - t0\)（毫秒）。

- 抖动（jitter）：时延的波动程度。
  - 常见量化方式：
    - 标准差抖动：样本标准差 \(s\)。
    - 相对中位数抖动：\(|x - \text{median}|\) 的分布。
    - 分位数抖动：通过 P50/P95/P99 描述整体与尾部（工程中最常用）。

- P50 / P95 / P99（分位数）：
  - P50（第 50 百分位，中位数）：50% 样本 \(\le\) 它。
  - P95：95% 样本 \(\le\) 它（仅 5% 更慢）。
  - P99：99% 样本 \(\le\) 它（极端尾部）。
  - 最近秩法（Nearest-Rank）：对 N 个样本升序排序，\(k = \lceil p/100 \times N \rceil\)，Pp = 第 k 个样本。

## 2. 采集与窗口

- 采样：每次交易外侧记录时延样本 \(x_i = t1 - t0\)。
  - 建议“成功交易样本用于时延统计；失败（CRC/超时/长度）的次数单独进入 FER（帧错率）”。避免将失败样本计入时延，防止分位数被异常拉高。

- 窗口：固定时间（如 1 分钟/30 分钟）或固定样本量（2k～10k）。
  - 为让 P95/P99 稳定，建议 \(N \ge 1000\)。

- 预热与溢出：
  - 可跳过前 10～50 个“预热”样本。
  - 32 位毫秒计数溢出时，使用无符号减法：`dt = (t1 - t0)` 自然按模 2^32 计算可安全跨越溢出。

## 3. 计算方法

- 平均值（均值）：
  $$\mu = \frac{1}{N} \sum_{i=1}^{N} x_i$$

- 方差（样本方差）与标准差：
  $$s^2 = \frac{1}{N-1} \sum_{i=1}^{N} (x_i - \mu)^2, \quad s = \sqrt{s^2}$$

- 分位数 P50/P95/P99：
  - 升序排序一次，用最近秩法取值；或使用选择算法（无需完整排序）。

- 可选“相对中位数抖动”：计算 \(|x_i - P50|\) 的 P95，直观反映相对波动。

## 4. 验收建议（示例）

- 稳定性：\(\text{P95} \le 1.5 \times \text{P50}\)
- 尾部受控：\(\text{P99} \le 2.0 \times \text{P50}\)
- 长尾警戒：\(\mu\) 不应显著大于 P50（否则可能长尾严重）。
- 可靠性：FER（bad_frames/total_frames）低于阈值（如 < 0.5%），并与时延统计分离报告。

> 注：阈值需按业务场景与链路能力调优，上述仅为通用工程参考线。

## 5. STM32/FreeRTOS 实战要点

- 时间源与精度：
  - 1 ms 粒度足够：`HAL_GetTick()` 或自有 `get_time_ms()`。
  - 若需亚毫秒：可用 DWT 周期计数换算微秒/毫秒。

- 调度与节拍：
  - 使用 `vTaskDelayUntil()` 固定节拍发起交易，避免节拍漂移影响统计。
  - 超时设置不宜过大，避免拖慢吞吐并降低窗口内有效样本数。

- 计算效率：
  - 在窗口末尾统一排序/计算，避免每次样本到来就重算。
  - 大样本时可用选择算法求分位数，降低 CPU 与 RAM 压力。

- 与 FER 的关系：
  - 时延分位数仅针对成功样本，FER 独立统计失败原因与占比，两者共同判定“稳定且可靠”。

## 6. 报告建议

- 基本字段：窗口时长/样本数、P50/P95/P99、均值、标准差、最小/最大；FER（含错误分类占比）。
- 通过/失败判定：按第 4 节阈值给出 PASS/FAIL，并附带简短诊断建议（如“长尾偏高，检查链路拥塞或重传超时”）。

### 示例输出模板

```
[COMM] window=30min samples=7200 ok=7150 bad=50 FER=0.69%
       lat(ms): P50=120 P95=160 P99=210 mean=125 std=18 min=110 max=260
       verdict: PASS (P95<=1.5xP50 & P99<=2.0xP50)
```

## 7. 术语速查

- Latency：单次交易时延，单位 ms。
- Jitter：时延的波动程度，可用标准差或分位数刻画。
- P50（Median）：第 50 百分位，中位数。
- P95 / P99：第 95/99 百分位，反映尾部慢包水平。
- FER：Frame Error Rate，帧错率（超时/CRC/长度等失败统计）。

---

如需，我可以将你代码中的统计窗口、样本容量与 PASS/FAIL 阈值统一到本指南，并将分位数计算替换为选择算法以降低排序开销。